name: Add issues to project on creation

on:
  issues:
    types: [opened]

jobs:
  add_to_project:
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to project, label, and fill fields
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.Project_bot_issues }}
          script: |
            const projectId = 'PVT_kwHOBwWtRc4A6wWB'
            const label = 'needs triage'

            // Step 1: Add label to issue
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            })

            // Step 2: Get issue node ID
            const issueId = (await github.graphql(`
              query {
                repository(owner: "${context.repo.owner}", name: "${context.repo.repo}") {
                  issue(number: ${context.issue.number}) {
                    id
                  }
                }
              }
            `)).repository.issue.id;

            // Step 3: Add issue to project and get item ID
            const addItemResponse = await github.graphql(`
              mutation {
                addProjectV2ItemById(input: {
                  projectId: "${projectId}",
                  contentId: "${issueId}"
                }) {
                  item {
                    id
                  }
                }
              }
            `);
            const itemId = addItemResponse.addProjectV2ItemById.item.id;

            // Step 4: Fill project fields
            const fieldUpdates = [
              {
                // Status = Backlog
                fieldId: "PVTSSF_lAHOBwWtRc4A6wWBzgvQZ6A",
                value: { singleSelectOptionId: "78730804" }
              },
              {
                // Priority = Medium
                fieldId: "PVTSSF_lAHOBwWtRc4A6wWBzgvQZ9o",
                value: { singleSelectOptionId: "8ca69e6f" }
              },
              {
                // Size = M
                fieldId: "PVTSSF_lAHOBwWtRc4A6wWBzgvQZ9s",
                value: { singleSelectOptionId: "1cc05ec6" }
              },
              {
                // Type = Tasks
                fieldId: "PVTSSF_lAHOBwWtRc4A6wWBzgvRHDE",
                value: { singleSelectOptionId: "0d73c906" }
              },
              {
                // QPP Objective = Objective 1
                fieldId: "PVTSSF_lAHOBwWtRc4A6wWBzgvQdmw",
                value: { singleSelectOptionId: "2f4a21a3" }
              }
            ]

            for (const { fieldId, value } of fieldUpdates) {
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: $value
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId,
                value
              });
            }
